<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>&shy;</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=" rel="icon" type="image/x-icon" />
  <script>
    var city = 'Cambridge, MA'; // TODO - allow input
    var API_URL = 'http://api.openweathermap.org/data/2.5/weather?q=' + city + '&type=accurate&APPID=0c040a9cff25f3b8906901b1513c2cab';

    var canvas = document.createElement('canvas');
    var context = canvas.getContext('2d');
    canvas.width = 32;
    canvas.height = 32;

    var getJSON = function(url, callback) {
      var xhr = new XMLHttpRequest();

      xhr.open('GET', url);
      xhr.onload = function () {
        if (this.status >= 200 && this.status < 400) {
          callback(JSON.parse(this.response));
        }
      };

      xhr.send();
    };

    var draw = function(tempFahrenheit) {
      context.textBaseline = 'top';
      context.textAlign = 'start';
      context.fontStretch = 1;
      context.angle = 0;

      //newSize = context.measureText(text).width // TODO - measure text to determine best font size
      context.font = "normal normal bold 22px/22px Arial";
      context.fillStyle = '#444';

      context.clearRect(0, 0, canvas.width, canvas.height);
      context.fillText(tempFahrenheit + 'Â°', -1, 4);

      document.head.querySelector('[type="image/x-icon"]').href = canvas.toDataURL();
    };

    var getTemp = function() {
      getJSON(API_URL, function (data) {
        var tempKelvin = data.main.temp;
        var tempFahrenheit = ((tempKelvin - 273.15).toPrecision(4) * 9 / 5 + 32).toPrecision(2);

        draw(tempFahrenheit);
      });
    };

    setInterval(getTemp, 60 * 1000);
    getTemp();
  </script>
</head>
